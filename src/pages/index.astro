---
import scheduleData from '../data/structured-schedule-data.json';

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
const now = new Date();
const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ DD.MM.YYYY
function parseDate(dateString: string) {
	const [day, month, year] = dateString.split('.');
	return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
}

// –§–∏–ª—å—Ç—Ä—É–µ–º –¥–Ω–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –∏ —Å–ª–µ–¥—É—é—â–∏–µ, –∏—Å–∫–ª—é—á–∞–µ–º –¥–Ω–∏ –±–µ–∑ –∑–∞–Ω—è—Ç–∏–π
const filteredDays = scheduleData.days.filter((day) => {
	const dayDate = parseDate(day.date);
	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–Ω—å, –µ—Å–ª–∏ –µ–≥–æ –¥–∞—Ç–∞ >= —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –ò –µ—Å—Ç—å –∑–∞–Ω—è—Ç–∏—è
	return dayDate >= today && day.lessons.length > 0;
});

// –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª–æ—Å–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
const currentDay = filteredDays.find(day => {
	const dayDate = parseDate(day.date);
	return dayDate.getTime() === today.getTime();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM
function getCurrentTime() {
	const now = new Date();
	return now.toTimeString().slice(0, 5);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å–ª–æ—Ç–µ
function isTimeInSlot(currentTime: string, startTime: string, endTime: string): boolean {
	const current = currentTime.split(':').map(Number);
	const start = startTime.split(':').map(Number);
	const end = endTime.split(':').map(Number);
	
	const currentMinutes = current[0] * 60 + current[1];
	const startMinutes = start[0] * 60 + start[1];
	const endMinutes = end[0] * 60 + end[1];
	
	return currentMinutes >= startMinutes && currentMinutes <= endMinutes;
}
---

<html lang="ru">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤ 1–ú</title>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				margin: 0;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				max-width: 1200px;
				margin: 0 auto;
				background: white;
				border-radius: 12px;
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
				overflow: hidden;
			}
			.header {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 30px;
				text-align: center;
			}
			.header h1 {
				margin: 0;
				font-size: 2.5rem;
				font-weight: 300;
			}
			.week-range {
				margin-top: 10px;
				font-size: 1.2rem;
				opacity: 0.9;
			}
			.current-day {
				margin-top: 8px;
				font-size: 1rem;
				opacity: 0.8;
				background: rgba(255, 255, 255, 0.2);
				padding: 8px 16px;
				border-radius: 20px;
				display: inline-block;
			}
			.schedule-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
				gap: 20px;
			}
			.day-card {
				background: #fafafa;
				border-radius: 8px;
				padding: 20px;
			}
			.day-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
				padding-bottom: 15px;
				border-bottom: 2px solid #e0e0e0;
			}
			.day-name {
				font-size: 1.4rem;
				font-weight: 600;
				color: #333;
			}
			.day-date {
				font-size: 1rem;
				color: #666;
			}
			.lesson {
				border-radius: 6px;
				padding: 15px 0;
				margin-bottom: 10px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			}
			.lesson-time {
				padding: 0 5px;
				font-weight: 600;
				color: #667eea;
				margin-bottom: 8px;
				font-size: 0.9rem;
			}
			.activity {
				background: #f8f9fa;
				border-radius: 4px;
				padding: 10px;
				margin-bottom: 8px;
				border-left: 3px solid #28a745;
			}
			.activity:last-child {
				margin-bottom: 0;
			}
			.subject {
				font-weight: 600;
				color: #333;
				margin-bottom: 4px;
			}
			.teacher, .room {
				font-size: 0.9rem;
				color: #666;
				margin-bottom: 2px;
			}
			.no-lessons {
				text-align: center;
				color: #999;
				font-style: italic;
				padding: 20px;
			}
			.metadata {
				background: #f8f9fa;
				padding: 20px 30px;
				border-top: 1px solid #e0e0e0;
				font-size: 0.9rem;
				color: #666;
			}
			
			/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–æ—Å–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ */
			.time-indicator {
				position: absolute;
				left: 0;
				right: 0;
				height: 2px;
				background: #ea4335;
				z-index: 10;
				box-shadow: 0 0 10px rgba(234, 67, 53, 0.5);
				transition: top 0.3s ease;
			}
			
			.time-indicator::before {
				content: '';
				position: absolute;
				left: -6px;
				top: -4px;
				width: 10px;
				height: 10px;
				background: #ea4335;
				border-radius: 50%;
				box-shadow: 0 0 5px rgba(234, 67, 53, 0.8);
			}
			
			.time-indicator::after {
				content: attr(data-time);
				position: absolute;
				right: 10px;
				top: -8px;
				background: #ea4335;
				color: white;
				padding: 2px 6px;
				border-radius: 3px;
				font-size: 11px;
				font-weight: 500;
				white-space: nowrap;
			}
			
			.schedule-container {
				position: relative;
			}
			
			.lesson-slot {
				position: relative;
				border-radius: 6px;
				padding: 15px 0;
				margin-bottom: 10px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
				transition: all 0.3s ease;
			}
			
			.lesson-slot.current-slot {
				background: linear-gradient(135deg, #f0f8ff 0%, #f5f0ff 100%);
				border: 2px solid #667eea;
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
			}

			.current-slot .activity {
				border: none;
			}
			
			.lesson-slot.past-slot {
				opacity: 0.6;
				background: #f5f5f5;
			}
			
			.lesson-slot.future-slot {
				background: #fafafa;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤</h1>
				<div class="week-range">{scheduleData.weekRange}</div>
				<div class="current-day">–°–µ–≥–æ–¥–Ω—è: {today.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
			</div>
			
			<div class="schedule-grid">
				{filteredDays.map((day) => {
					const isCurrentDay = parseDate(day.date).getTime() === today.getTime();
					
					return (
						<div class="day-card">
							<div class="day-header">
								<div class="day-name">{day.dayName}</div>
								<div class="day-date">{day.date}</div>
							</div>
							
							<div class="schedule-container">
								{isCurrentDay && <div id="timeIndicator" class="time-indicator" style="display: none;"></div>}
								
								{day.lessons.map((lesson, index) => {
									let slotClass = 'lesson-slot';
									
									// –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
									if (isCurrentDay) {
										const currentTime = getCurrentTime();
										const isCurrent = isTimeInSlot(currentTime, lesson.timeSlot.start, lesson.timeSlot.end);
										const isPast = currentTime > lesson.timeSlot.end;
										const isFuture = currentTime < lesson.timeSlot.start;
										
										if (isCurrent) slotClass += ' current-slot';
										else if (isPast) slotClass += ' past-slot';
										else if (isFuture) slotClass += ' future-slot';
									}
									
									return (
										<div class={slotClass} data-start={lesson.timeSlot.start} data-end={lesson.timeSlot.end}>
											<div class="lesson-time">{lesson.timeSlot.start} - {lesson.timeSlot.end}</div>
											{lesson.lessons.map((activity) => (
												<div class="activity">
													<div class="subject">{activity.subject}</div>
													{activity.teacher && <div class="teacher">üë®‚Äçüè´ {activity.teacher}</div>}
													{activity.room && <div class="room">üè¢ {activity.room}</div>}
												</div>
											))}
										</div>
									);
								})}
							</div>
						</div>
					);
				})}
			</div>
			
			<div class="metadata">
				<p><strong>–í—Å–µ –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.</strong></p>
				<p>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å —Å–∞–π—Ç–∞ <a href="https://schedule.mstimetables.ru/" target="_blank" rel="noopener">schedule.mstimetables.ru</a>.</p>
				<p>–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞: {new Date(scheduleData.metadata.lastModified).toLocaleString('ru-RU')}</p>
			</div>
		</div>
		
		<script>
			// @ts-nocheck
			// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–ª–æ—Ç–µ (–¥—É–±–ª–∏—Ä—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ª–æ–≥–∏–∫—É)
			/**
			 * @param {string} currentTime
			 * @param {string} startTime
			 * @param {string} endTime
			 * @returns {boolean}
			 */
			function isTimeInSlot(/** @type {string} */ currentTime, /** @type {string} */ startTime, /** @type {string} */ endTime) {
				const current = currentTime.split(':').map(Number);
				const start = startTime.split(':').map(Number);
				const end = endTime.split(':').map(Number);
				
				const currentMinutes = current[0] * 60 + current[1];
				const startMinutes = start[0] * 60 + start[1];
				const endMinutes = end[0] * 60 + end[1];
				
				return currentMinutes >= startMinutes && currentMinutes <= endMinutes;
			}
			
			// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–æ—Å–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
			function updateTimeIndicator() {
				const timeIndicator = document.getElementById('timeIndicator');
				if (!timeIndicator) return;
				
				const currentTime = new Date();
				const currentTimeString = currentTime.toTimeString().slice(0, 5);
				
				// –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–ª–æ—Ç –≤ —Ç–µ–∫—É—â–µ–º –¥–Ω–µ
				const currentSlot = document.querySelector('.current-slot');
				const container = timeIndicator.parentElement;
				
				if (currentSlot && container) {
					const slotRect = currentSlot.getBoundingClientRect();
					const containerRect = container.getBoundingClientRect();
					
					// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–ª–æ—Å–∫—É –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–Ω—è
					const relativeTop = slotRect.top - containerRect.top;
					const slotHeight = slotRect.height;
					const startTime = currentSlot.getAttribute('data-start');
					const endTime = currentSlot.getAttribute('data-end');
					
					if (startTime && endTime) {
						// –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤–Ω—É—Ç—Ä–∏ —Å–ª–æ—Ç–∞
						const startMinutes = parseInt(startTime.split(':')[0]) * 60 + parseInt(startTime.split(':')[1]);
						const endMinutes = parseInt(endTime.split(':')[0]) * 60 + parseInt(endTime.split(':')[1]);
						const currentMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();
						
						const progress = (currentMinutes - startMinutes) / (endMinutes - startMinutes);
						const positionInSlot = progress * slotHeight;
						
						timeIndicator.style.top = (relativeTop + positionInSlot) + 'px';
						timeIndicator.style.display = 'block';
						timeIndicator.setAttribute('data-time', currentTimeString);
					}
				} else {
					timeIndicator.style.display = 'none';
				}
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ—Ç–æ–≤ –≤ —Ç–µ–∫—É—â–µ–º –¥–Ω–µ
				const currentDayContainer = timeIndicator.parentElement;
				if (currentDayContainer) {
					currentDayContainer.querySelectorAll('.lesson-slot').forEach(slot => {
						const startTime = slot.getAttribute('data-start');
						const endTime = slot.getAttribute('data-end');
						const currentTimeStr = currentTimeString;
						
						if (startTime && endTime) {
							slot.classList.remove('current-slot', 'past-slot', 'future-slot');
							
							if (isTimeInSlot(currentTimeStr, startTime, endTime)) {
								slot.classList.add('current-slot');
							} else if (currentTimeStr > endTime) {
								slot.classList.add('past-slot');
							} else if (currentTimeStr < startTime) {
								slot.classList.add('future-slot');
							}
						}
					});
				}
			}
			
			// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ—Å–∫—É –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
			updateTimeIndicator();
			setInterval(updateTimeIndicator, 60000);
			
			// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
			window.addEventListener('scroll', updateTimeIndicator);
			window.addEventListener('resize', updateTimeIndicator);
		</script>
	</body>
</html>
