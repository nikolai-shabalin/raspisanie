---
import scheduleData from '../data/structured-schedule-data.json';

// Определяем текущую дату
const now = new Date();
const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Убираем время, оставляем только дату

// Функция для парсинга даты из формата DD.MM.YYYY
function parseDate(dateString: string) {
	const [day, month, year] = dateString.split('.');
	return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
}

// Разделяем дни: прошедшие и предстоящие (исключаем дни без занятий)
const pastDays = scheduleData.days.filter((day) => {
	const dayDate = parseDate(day.date);
	return dayDate < today && day.lessons.length > 0;
});

const upcomingDays = scheduleData.days.filter((day) => {
	const dayDate = parseDate(day.date);
	return dayDate >= today && day.lessons.length > 0;
});

// Получаем текущий день для отображения полоски времени
const currentDay = scheduleData.days.find(day => {
	const dayDate = parseDate(day.date);
	return dayDate.getTime() === today.getTime();
});

// Функция для получения текущего времени в формате HH:MM
function getCurrentTime() {
	const now = new Date();
	return now.toTimeString().slice(0, 5);
}

// Функция для проверки, находится ли текущее время в определенном временном слоте
function isTimeInSlot(currentTime: string, startTime: string, endTime: string): boolean {
	const current = currentTime.split(':').map(Number);
	const start = startTime.split(':').map(Number);
	const end = endTime.split(':').map(Number);
	
	const currentMinutes = current[0] * 60 + current[1];
	const startMinutes = start[0] * 60 + start[1];
	const endMinutes = end[0] * 60 + end[1];
	
	return currentMinutes >= startMinutes && currentMinutes <= endMinutes;
}


// Функция для получения информации о текущем уроке
function getCurrentLessonInfo() {
	const currentTime = getCurrentTime();
	
	// Проверяем, является ли сегодня выходным
	const today = new Date();
	const dayOfWeek = today.getDay(); // 0 = воскресенье, 6 = суббота
	
	// Проверяем только текущий день
	if (!currentDay) {
		// Если нет данных о текущем дне, проверяем, выходной ли это
		if (dayOfWeek === 0 || dayOfWeek === 6) {
			return {
				hasLesson: false,
				message: "Выходной"
			};
		}
		return {
			hasLesson: false,
			message: "Сейчас нет занятий"
		};
	}
	
	// Сначала проверяем, выходной ли это день
	if (dayOfWeek === 0 || dayOfWeek === 6) {
		return {
			hasLesson: false,
			message: "Выходной"
		};
	}
	
	// Ищем текущий урок
	for (const lesson of currentDay.lessons) {
		if (isTimeInSlot(currentTime, lesson.timeSlot.start, lesson.timeSlot.end)) {
			const activity = lesson.lessons[0]; // Берем первое занятие из слота
			return {
				hasLesson: true,
				message: `Сейчас: ${activity.subject}${activity.room ? ` в ${activity.room}` : ''}${activity.teacher ? ` с ${activity.teacher}` : ''}`,
				timeSlot: `${lesson.timeSlot.start} - ${lesson.timeSlot.end}`
			};
		}
	}
	
	// Если не нашли текущий урок, проверяем, есть ли занятия сегодня
	if (currentDay.lessons.length === 0) {
		return {
			hasLesson: false,
			message: "Сейчас нет занятий"
		};
	}
	
	// Проверяем, закончились ли все занятия
	const lastLesson = currentDay.lessons[currentDay.lessons.length - 1];
	if (currentTime > lastLesson.timeSlot.end) {
		return {
			hasLesson: false,
			message: "Все занятия на сегодня закончились"
		};
	}
	
	// Проверяем, еще не начались ли занятия
	const firstLesson = currentDay.lessons[0];
	if (currentTime < firstLesson.timeSlot.start) {
		return {
			hasLesson: false,
			message: `Занятия начнутся в ${firstLesson.timeSlot.start}`
		};
	}
	
	// Между занятиями
	return {
		hasLesson: false,
		message: "Сейчас перерыв между занятиями"
	};
}
---

<html lang="ru">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href={`${import.meta.env.BASE_URL}favicon.svg`} />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- PWA Meta Tags -->
		<meta name="application-name" content="Расписание уроков 1М" />
		<meta name="description" content="Приложение для просмотра расписания уроков класса 1М" />
		<meta name="theme-color" content="#667eea" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="default" />
		<meta name="apple-mobile-web-app-title" content="Расписание" />
		<meta name="msapplication-TileColor" content="#667eea" />
		<meta name="msapplication-tap-highlight" content="no" />
		
		<!-- PWA Manifest -->
		<link rel="manifest" href={`${import.meta.env.BASE_URL}manifest.json`} />
		
		<!-- Apple Touch Icons -->
		<link rel="apple-touch-icon" href={`${import.meta.env.BASE_URL}icon-192.svg`} />
		<link rel="apple-touch-icon" sizes="152x152" href={`${import.meta.env.BASE_URL}icon-144.svg`} />
		<link rel="apple-touch-icon" sizes="180x180" href={`${import.meta.env.BASE_URL}icon-192.svg`} />
		<link rel="apple-touch-icon" sizes="167x167" href={`${import.meta.env.BASE_URL}icon-144.svg`} />
		
		<!-- Favicons -->
		<link rel="icon" type="image/svg+xml" sizes="192x192" href={`${import.meta.env.BASE_URL}icon-192.svg`} />
		<link rel="icon" type="image/svg+xml" sizes="512x512" href={`${import.meta.env.BASE_URL}icon-512.svg`} />
		
		<link rel="icon" href={`${import.meta.env.BASE_URL}favicon.ico`} />

		<title>Расписание уроков 1М</title>
		<style>
			:root {
				--bg-color: #f5f5f5;
				--container-bg: white;
				--text-color: #333;
				--text-secondary: #666;
				--text-muted: #999;
				--border-color: #e0e0e0;
				--card-bg: #fafafa;
				--activity-bg: #f8f9fa;
				--shadow-color: rgba(0, 0, 0, 0.1);
				--gradient-start: #667eea;
				--gradient-end: #764ba2;

				/* Цвета для предметов */
				--subject-study: #4CAF50; /* учебный блок - зеленый */
				--subject-english: #2196F3; /* английский - синий */
				--subject-sport: #FF9800; /* спорт - оранжевый */
				--subject-walk: #8BC34A; /* прогулка - светло-зеленый */
				--subject-lunch: #FF5722; /* обед - красно-оранжевый */
				--subject-choice: #9C27B0; /* по выбору - фиолетовый */
				--subject-thinking: #00BCD4; /* мышление - голубой */
				--subject-tutor: #3F51B5; /* тьюторский час - индиго */
				--subject-neuron: #E91E63; /* Нейрон - розовый */
			}

			@media (prefers-color-scheme: dark) {
				:root {
					--bg-color: #121212;
					--container-bg: #1e1e1e;
					--text-color: #e0e0e0;
					--text-secondary: #b0b0b0;
					--text-muted: #808080;
					--border-color: #2d2d2d;
					--card-bg: #252525;
					--activity-bg: #2a2a2a;
					--shadow-color: rgba(0, 0, 0, 0.3);
					--gradient-start: #4a5d9e;
					--gradient-end: #553677;

					/* Темные версии цветов для предметов */
					--subject-study: #81C784; /* учебный блок - темно-зеленый */
					--subject-english: #64B5F6; /* английский - темно-синий */
					--subject-sport: #FFB74D; /* спорт - темно-оранжевый */
					--subject-walk: #AED581; /* прогулка - темный светло-зеленый */
					--subject-lunch: #FF8A65; /* обед - темный красно-оранжевый */
					--subject-choice: #BA68C8; /* по выбору - темно-фиолетовый */
					--subject-thinking: #4DD0E1; /* мышление - темно-голубой */
					--subject-tutor: #7986CB; /* тьюторский час - темный индиго */
					--subject-neuron: #F06292; /* Нейрон - темно-розовый */
				}
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				margin: 0;
				background-color: var(--bg-color);
				color: var(--text-color);
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
				background: var(--container-bg);
				border-radius: 0;
				box-shadow: 0 4px 6px var(--shadow-color);
			}

			
			@media (min-width: 600px) {
				body {
					padding: 20px;
				}
				
				.container {
					overflow: hidden;
					border-radius: 12px;
				}
			}
			.header {
				background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
				color: white;
				padding: 30px;
				text-align: center;
				transition: all 0.3s ease;
			}
			.header h1 {
				margin: 0;
				font-size: 2.7rem;
				font-weight: 300;
				transition: font-size 0.3s ease;
			}
			.week-range {
				margin-top: 10px;
				font-size: 1.4rem;
				opacity: 0.9;
				transition: all 0.3s ease;
			}
			.current-day {
				margin-top: 8px;
				font-size: 1.2rem;
				opacity: 0.8;
				background: rgba(255, 255, 255, 0.2);
				padding: 8px 16px;
				border-radius: 20px;
				display: inline-block;
				transition: all 0.3s ease;
			}
			
			/* Стили для мобильной версии шапки */
			@media (max-width: 600px) {
				.header {
					padding: 15px;
				}
				.header h1 {
					font-size: 1.8rem;
				}
				.week-range {
					margin-top: 5px;
					font-size: 1rem;
				}
				.current-day {
					margin-top: 5px;
					font-size: 0.9rem;
					padding: 4px 12px;
				}
				
				
				/* На мобильных убираем grid и делаем вертикальный список */
				.schedule-grid {
					display: block;
				}
				
				/* Убираем скругления на мобильных для лучшей работы sticky */
				.day-section {
					border-radius: 0 !important;
					margin-bottom: 0;
				}
			}
			.schedule-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
				gap: 20px;
			}
			.day-section {
				background: var(--card-bg);
				border-radius: 8px;
				margin-bottom: 20px;
			}
			.day-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
				padding: 15px 20px;
				border-bottom: 2px solid var(--border-color);
				background: var(--card-bg);
				position: sticky;
				top: 0;
				z-index: 10;
				box-shadow: 0 2px 4px var(--shadow-color);
			}
			.day-name {
				font-size: 1.6rem;
				font-weight: 600;
				color: var(--text-color);
			}
			.day-date {
				font-size: 1.2rem;
				color: var(--text-secondary);
			}
			.lesson {
				border-radius: 6px;
				padding: 15px 0;
				margin-bottom: 10px;
				box-shadow: 0 2px 4px var(--shadow-color);
			}
			.lesson-time {
				padding: 0 5px;
				font-weight: 600;
				color: var(--gradient-start);
				margin-bottom: 8px;
				font-size: 1.1rem;
			}
			.activity {
				background: var(--activity-bg);
				border-radius: 4px;
				padding: 10px;
				margin-bottom: 8px;
				border-left: 3px solid var(--gradient-start);
				transition: all 0.3s ease;
			}

			/* Стили для разных предметов */
			.activity[data-subject="учебный блок"] {
				border-left-color: var(--subject-study);
				background: color-mix(in srgb, var(--subject-study) 10%, var(--activity-bg));
			}
			.activity[data-subject="английский"] {
				border-left-color: var(--subject-english);
				background: color-mix(in srgb, var(--subject-english) 10%, var(--activity-bg));
			}
			.activity[data-subject="спорт"] {
				border-left-color: var(--subject-sport);
				background: color-mix(in srgb, var(--subject-sport) 10%, var(--activity-bg));
			}
			.activity[data-subject="прогулка"] {
				border-left-color: var(--subject-walk);
				background: color-mix(in srgb, var(--subject-walk) 10%, var(--activity-bg));
			}
			.activity[data-subject="обед"] {
				border-left-color: var(--subject-lunch);
				background: color-mix(in srgb, var(--subject-lunch) 10%, var(--activity-bg));
			}
			.activity[data-subject="по выбору"] {
				border-left-color: var(--subject-choice);
				background: color-mix(in srgb, var(--subject-choice) 10%, var(--activity-bg));
			}
			.activity[data-subject="мышление"] {
				border-left-color: var(--subject-thinking);
				background: color-mix(in srgb, var(--subject-thinking) 10%, var(--activity-bg));
			}
			.activity[data-subject="тьюторский час"] {
				border-left-color: var(--subject-tutor);
				background: color-mix(in srgb, var(--subject-tutor) 10%, var(--activity-bg));
			}
			.activity[data-subject="Нейрон"] {
				border-left-color: var(--subject-neuron);
				background: color-mix(in srgb, var(--subject-neuron) 10%, var(--activity-bg));
			}
			.activity:last-child {
				margin-bottom: 0;
			}
			.subject {
				font-weight: 600;
				color: var(--text-color);
				margin-bottom: 4px;
			}
			.teacher, .room {
				font-size: 1.1rem;
				color: var(--text-secondary);
				margin-bottom: 2px;
			}
			.no-lessons {
				text-align: center;
				color: var(--text-muted);
				font-style: italic;
				padding: 20px;
			}
			.metadata {
				background: var(--activity-bg);
				padding: 20px 30px;
				border-top: 1px solid var(--border-color);
				font-size: 1.1rem;
				color: var(--text-secondary);
			}
			
			/* Стили для полоски времени */
			.time-indicator {
				position: absolute;
				left: 0;
				right: 0;
				height: 2px;
				background: #ea4335;
				z-index: 10;
				box-shadow: 0 0 10px rgba(234, 67, 53, 0.5);
				transition: top 0.3s ease;
			}
			
			.time-indicator::before {
				content: '';
				position: absolute;
				left: -6px;
				top: -4px;
				width: 10px;
				height: 10px;
				background: #ea4335;
				border-radius: 50%;
				box-shadow: 0 0 5px rgba(234, 67, 53, 0.8);
			}
			
			.time-indicator::after {
				content: attr(data-time);
				position: absolute;
				right: 10px;
				top: -8px;
				background: #ea4335;
				color: white;
				padding: 2px 6px;
				border-radius: 3px;
				font-size: 13px;
				font-weight: 500;
				white-space: nowrap;
			}
			
			.day-content {
				position: relative;
				padding: 0 20px 20px 20px;
			}
			
			.lesson-slot {
				position: relative;
				border-radius: 6px;
				padding: 15px 0;
				margin-bottom: 10px;
				box-shadow: 0 2px 4px var(--shadow-color);
				transition: all 0.3s ease;
				background: var(--card-bg);
			}
			
			.lesson-slot.current-slot {
				background: linear-gradient(135deg, 
					color-mix(in srgb, var(--gradient-start) 10%, var(--card-bg)) 0%,
					color-mix(in srgb, var(--gradient-end) 10%, var(--card-bg)) 100%
				);
				border: 2px solid var(--gradient-start);
				box-shadow: 0 4px 12px color-mix(in srgb, var(--gradient-start) 20%, transparent);
			}

			.current-slot .activity {
				border: none;
			}
			
			.lesson-slot.past-slot {
				opacity: 0.6;
				background: color-mix(in srgb, var(--card-bg) 80%, black);
			}
			
			.lesson-slot.future-slot {
				background: var(--card-bg);
			}
			
			
			/* Анимации для уведомлений */
			@keyframes slideDown {
				from {
					opacity: 0;
					transform: translateX(-50%) translateY(-20px);
				}
				to {
					opacity: 1;
					transform: translateX(-50%) translateY(0);
				}
			}
			
			@keyframes slideUp {
				from {
					opacity: 1;
					transform: translateX(-50%) translateY(0);
				}
				to {
					opacity: 0;
					transform: translateX(-50%) translateY(-20px);
				}
			}
			
			/* Стили для блока событий */
			.events-section {
				background: var(--card-bg);
				margin: 20px;
				border-radius: 12px;
				box-shadow: 0 2px 8px var(--shadow-color);
				overflow: hidden;
			}
			
			.events-section h2 {
				margin: 0 0 20px 0;
				font-size: 1.6rem;
				font-weight: 600;
				color: var(--text-color);
				padding: 0 20px;
			}
			
			.events-list {
				padding: 20px;
			}
			
			.event-item {
				background: var(--activity-bg);
				border-radius: 8px;
				padding: 15px;
				margin-bottom: 15px;
				border-left: 4px solid var(--gradient-start);
				transition: all 0.3s ease;
				position: relative;
			}
			
			.event-item:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 12px var(--shadow-color);
			}
			
			.event-item:last-child {
				margin-bottom: 0;
			}
			
			.event-date {
				font-size: 1.1rem;
				font-weight: 600;
				color: var(--gradient-start);
				margin-bottom: 8px;
			}
			
			.event-title {
				font-size: 1.2rem;
				font-weight: 600;
				color: var(--text-color);
				margin-bottom: 8px;
				line-height: 1.4;
			}
			
			
			.event-location {
				font-size: 1rem;
				color: var(--text-secondary);
				margin-bottom: 12px;
			}
			
			.event-actions {
				display: flex;
				gap: 10px;
				flex-wrap: wrap;
			}
			
			.event-btn {
				background: var(--gradient-start);
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 20px;
				font-size: 0.9rem;
				font-weight: 500;
				text-decoration: none;
				display: inline-flex;
				align-items: center;
				gap: 6px;
				transition: all 0.3s ease;
				cursor: pointer;
			}
			
			.event-btn:hover {
				background: var(--gradient-end);
				transform: translateY(-1px);
				box-shadow: 0 2px 8px color-mix(in srgb, var(--gradient-start) 30%, transparent);
			}
			
			
			.no-events {
				text-align: center;
				color: var(--text-muted);
				font-style: italic;
				padding: 40px 20px;
			}
			
			@media (max-width: 600px) {
				.events-section {
					margin: 10px;
					border-radius: 8px;
				}
				
				.events-section h2 {
					font-size: 1.4rem;
					padding: 0 15px;
				}
				
				.events-list {
					padding: 15px;
				}
				
				.event-item {
					padding: 12px;
				}
				
				.event-title {
					font-size: 1.1rem;
				}
				
				.event-btn {
					justify-content: center;
				}
			}

			/* Прошедшие дни: details/summary */
			.past-days {
				margin: 20px;
			}
			.past-day {
				background: var(--card-bg);
				border-radius: 8px;
				box-shadow: 0 2px 6px var(--shadow-color);
				margin-bottom: 12px;
				overflow: hidden;
			}
			.past-day summary {
				list-style: none;
				cursor: pointer;
				padding: 14px 20px;
				border-bottom: 1px solid var(--border-color);
				background: var(--card-bg);
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.past-day summary::-webkit-details-marker { display: none; }
			.past-day .past-link {
				color: var(--gradient-start);
				text-decoration: underline;
				font-weight: 600;
			}
			.past-day .day-date {
				color: var(--text-secondary);
				font-weight: 500;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>Расписание уроков</h1>
				<div class="week-range">{scheduleData.weekRange}</div>
				<div class="current-day">{getCurrentLessonInfo().message}</div>
			</div>
			
			<!-- Блок ближайших событий -->
			<div class="events-section">
				<h2>📅 Ближайшие события</h2>
				<div class="events-list">
					<div class="event-item">
						<div class="event-date">26 сентября в 16:00</div>
						<div class="event-title">Сердечные истории вещей – семейное чаепитие первых классов!</div>
						<div class="event-location">📍 школа ИлИ</div>
						<div class="event-actions">
							<a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=Сердечные истории вещей – семейное чаепитие первых классов!&dates=20240926T130000Z/20240926T140000Z&details=26 сентября, в 16:00, ждем вас в школе ИлИ – будем ещё ближе знакомиться, играть и, конечно, пить чай с угощениями.&location=школа ИлИ" target="_blank" rel="noopener" class="event-btn">
								📅 Добавить в календарь
							</a>
						</div>
					</div>
				</div>
			</div>
			
			{pastDays.length > 0 && (
				<div class="past-days">
					{pastDays.map((day) => (
						<details class="past-day">
							<summary>
								<a class="past-link">{day.dayName}</a>
								<span class="day-date">{day.date}</span>
							</summary>
							<div class="day-content">
								{day.lessons.map((lesson) => (
									<div class="lesson-slot" data-start={lesson.timeSlot.start} data-end={lesson.timeSlot.end}>
										<div class="lesson-time">{lesson.timeSlot.start} - {lesson.timeSlot.end}</div>
										{lesson.lessons.map((activity) => (
											<div class="activity" data-subject={activity.subject}>
												<div class="subject">{activity.subject}</div>
												{activity.teacher && <div class="teacher">👨‍🏫 {activity.teacher}</div>}
												{activity.room && <div class="room">🏢 {activity.room}</div>}
											</div>
										))}
									</div>
								))}
							</div>
						</details>
					))}
				</div>
			)}

			<div class="schedule-grid">
				{upcomingDays.map((day) => {
					const isCurrentDay = parseDate(day.date).getTime() === today.getTime();
					
					return (
						<div class="day-section">
							<div class="day-header">
								<div class="day-name">{day.dayName}</div>
								<div class="day-date">{day.date}</div>
							</div>
							
							<div class="day-content">
								{/* timeIndicator создаётся на клиенте в ensureTimeIndicatorExists() */}
								
								{day.lessons.map((lesson, index) => {
									let slotClass = 'lesson-slot';
									
									// Применяем временные классы только для текущего дня
									if (isCurrentDay) {
										const currentTime = getCurrentTime();
										const isCurrent = isTimeInSlot(currentTime, lesson.timeSlot.start, lesson.timeSlot.end);
										const isPast = currentTime > lesson.timeSlot.end;
										const isFuture = currentTime < lesson.timeSlot.start;
										
										if (isCurrent) slotClass += ' current-slot';
										else if (isPast) slotClass += ' past-slot';
										else if (isFuture) slotClass += ' future-slot';
									}
									
									return (
										<div class={slotClass} data-start={lesson.timeSlot.start} data-end={lesson.timeSlot.end}>
											<div class="lesson-time">{lesson.timeSlot.start} - {lesson.timeSlot.end}</div>
											{lesson.lessons.map((activity) => (
												<div class="activity" data-subject={activity.subject}>
													<div class="subject">{activity.subject}</div>
													{activity.teacher && <div class="teacher">👨‍🏫 {activity.teacher}</div>}
													{activity.room && <div class="room">🏢 {activity.room}</div>}
												</div>
											))}
										</div>
									);
								})}
							</div>
						</div>
					);
				})}
			</div>
			
			<div class="metadata">
				<p><strong>Все данные берутся из открытых источников.</strong></p>
				<p>Расписание получено автоматически с сайта <a href="https://schedule.mstimetables.ru/" target="_blank" rel="noopener">schedule.mstimetables.ru</a>.</p>
				<p>Дата последнего парсинга: {new Date(scheduleData.metadata.lastModified).toLocaleString('ru-RU')}</p>
			</div>
		</div>
		
		<script>
			// @ts-nocheck
			
			// Глобальные переменные для оффлайн-поддержки
			let isOnline = navigator.onLine;
			let serviceWorkerRegistration = null;
			
			// Функция для проверки времени в слоте (дублируем серверную логику)
			/**
			 * @param {string} currentTime
			 * @param {string} startTime
			 * @param {string} endTime
			 * @returns {boolean}
			 */
			function isTimeInSlot(/** @type {string} */ currentTime, /** @type {string} */ startTime, /** @type {string} */ endTime) {
				const current = currentTime.split(':').map(Number);
				const start = startTime.split(':').map(Number);
				const end = endTime.split(':').map(Number);
				
				const currentMinutes = current[0] * 60 + current[1];
				const startMinutes = start[0] * 60 + start[1];
				const endMinutes = end[0] * 60 + end[1];
				
				return currentMinutes >= startMinutes && currentMinutes <= endMinutes;
			}
			
			// Функция для получения информации о текущем уроке (дублируем серверную логику)
			function getCurrentLessonInfo() {
				const currentTime = new Date().toTimeString().slice(0, 5);
				const indicator = document.getElementById('timeIndicator');
				const currentDayContainer = indicator ? indicator.closest('.day-section') : document.querySelector('.day-section');
				
				// Проверяем, является ли сегодня выходным
				const today = new Date();
				const dayOfWeek = today.getDay(); // 0 = воскресенье, 6 = суббота
				
				if (!currentDayContainer) {
					// Если нет данных о текущем дне, проверяем, выходной ли это
					if (dayOfWeek === 0 || dayOfWeek === 6) {
						return {
							hasLesson: false,
							message: "Выходной"
						};
					}
					return {
						hasLesson: false,
						message: "Сейчас нет занятий"
					};
				}
				
				// Сначала проверяем, выходной ли это день
				if (dayOfWeek === 0 || dayOfWeek === 6) {
					return {
						hasLesson: false,
						message: "Выходной"
					};
				}
				
				const lessonSlots = currentDayContainer.querySelectorAll('.lesson-slot');
				
				// Ищем текущий урок
				for (const slot of lessonSlots) {
					const startTime = slot.getAttribute('data-start');
					const endTime = slot.getAttribute('data-end');
					
					if (startTime && endTime && isTimeInSlot(currentTime, startTime, endTime)) {
						const activity = slot.querySelector('.activity');
						if (activity) {
							const subject = activity.querySelector('.subject')?.textContent || '';
							const teacher = activity.querySelector('.teacher')?.textContent?.replace('👨‍🏫 ', '') || '';
							const room = activity.querySelector('.room')?.textContent?.replace('🏢 ', '') || '';
							
							let message = `Сейчас: ${subject}`;
							if (room) message += ` в ${room}`;
							if (teacher) message += ` с ${teacher}`;
							
							return {
								hasLesson: true,
								message: message,
								timeSlot: `${startTime} - ${endTime}`
							};
						}
					}
				}
				
				// Если не нашли текущий урок, проверяем статус
				if (lessonSlots.length === 0) {
					return {
						hasLesson: false,
						message: "Сейчас нет занятий"
					};
				}
				
				// Проверяем, закончились ли все занятия
				const lastSlot = lessonSlots[lessonSlots.length - 1];
				const lastEndTime = lastSlot.getAttribute('data-end');
				if (lastEndTime && currentTime > lastEndTime) {
					return {
						hasLesson: false,
						message: "Все занятия на сегодня закончились"
					};
				}
				
				// Проверяем, еще не начались ли занятия
				const firstSlot = lessonSlots[0];
				const firstStartTime = firstSlot.getAttribute('data-start');
				if (firstStartTime && currentTime < firstStartTime) {
					return {
						hasLesson: false,
						message: `Занятия начнутся в ${firstStartTime}`
					};
				}
				
				// Между занятиями
				return {
					hasLesson: false,
					message: "Сейчас перерыв между занятиями"
				};
			}
			
			// Функция для обновления информации о текущем уроке
			function updateCurrentLessonInfo() {
				const currentDayElement = document.querySelector('.current-day');
				if (currentDayElement) {
					const lessonInfo = getCurrentLessonInfo();
					currentDayElement.textContent = lessonInfo.message;
				}
			}
			
			// Функция для обновления полоски времени
			function updateTimeIndicator() {
				const timeIndicator = document.getElementById('timeIndicator');
				if (!timeIndicator) return;
				
				const currentTime = new Date();
				const currentTimeString = currentTime.toTimeString().slice(0, 5);
				
				// Находим текущий временной слот в текущем дне
				const currentSlot = document.querySelector('.current-slot');
				const container = timeIndicator.parentElement;
				
				if (currentSlot && container) {
					const slotRect = currentSlot.getBoundingClientRect();
					const containerRect = container.getBoundingClientRect();
					
					// Позиционируем полоску времени относительно контейнера дня
					const relativeTop = slotRect.top - containerRect.top;
					const slotHeight = slotRect.height;
					const startTime = currentSlot.getAttribute('data-start');
					const endTime = currentSlot.getAttribute('data-end');
					
					if (startTime && endTime) {
						// Вычисляем позицию внутри слота
						const startMinutes = parseInt(startTime.split(':')[0]) * 60 + parseInt(startTime.split(':')[1]);
						const endMinutes = parseInt(endTime.split(':')[0]) * 60 + parseInt(endTime.split(':')[1]);
						const currentMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();
						
						const progress = (currentMinutes - startMinutes) / (endMinutes - startMinutes);
						const positionInSlot = progress * slotHeight;
						
						timeIndicator.style.top = (relativeTop + positionInSlot) + 'px';
						timeIndicator.style.display = 'block';
						timeIndicator.setAttribute('data-time', currentTimeString);
					}
				} else {
					timeIndicator.style.display = 'none';
				}
				
				// Обновляем классы только для слотов в текущем дне
				const currentDayContainer = timeIndicator.parentElement;
				if (currentDayContainer) {
					currentDayContainer.querySelectorAll('.lesson-slot').forEach(slot => {
						const startTime = slot.getAttribute('data-start');
						const endTime = slot.getAttribute('data-end');
						const currentTimeStr = currentTimeString;
						
						if (startTime && endTime) {
							slot.classList.remove('current-slot', 'past-slot', 'future-slot');
							
							if (isTimeInSlot(currentTimeStr, startTime, endTime)) {
								slot.classList.add('current-slot');
							} else if (currentTimeStr > endTime) {
								slot.classList.add('past-slot');
							} else if (currentTimeStr < startTime) {
								slot.classList.add('future-slot');
							}
						}
					});
				}
			}

			// Создаем индикатор времени на клиенте, если он не был отрендерен на сервере
			function ensureTimeIndicatorExists() {
				if (document.getElementById('timeIndicator')) return;

				// Форматируем сегодняшнюю дату как DD.MM.YYYY
				const now = new Date();
				const dd = String(now.getDate()).padStart(2, '0');
				const mm = String(now.getMonth() + 1).padStart(2, '0');
				const yyyy = String(now.getFullYear());
				const todayStr = `${dd}.${mm}.${yyyy}`;

				const daySections = document.querySelectorAll('.day-section');
				for (const section of daySections) {
					const dateEl = section.querySelector('.day-date');
					if (dateEl && dateEl.textContent && dateEl.textContent.trim() === todayStr) {
						const dayContent = section.querySelector('.day-content');
						if (dayContent) {
							const indicator = document.createElement('div');
							indicator.id = 'timeIndicator';
							indicator.className = 'time-indicator';
							indicator.style.display = 'none';
							dayContent.prepend(indicator);
						}
						break;
					}
				}
			}
			
			// Обеспечиваем наличие индикатора, затем выполняем первичное обновление
			ensureTimeIndicatorExists();
			updateTimeIndicator();
			updateCurrentLessonInfo();
			
			// Обновляем при прокрутке
			window.addEventListener('scroll', updateTimeIndicator);
			window.addEventListener('resize', updateTimeIndicator);
			
			// Функции для оффлайн-поддержки
			function updateOnlineStatus() {
				isOnline = navigator.onLine;
			}
			
			function showOfflineMessage() {
				const message = document.createElement('div');
				message.id = 'offlineMessage';
				message.style.cssText = `
					position: fixed;
					top: 20px;
					left: 50%;
					transform: translateX(-50%);
					background: color-mix(in srgb, var(--gradient-start) 80%, black);
					color: white;
					padding: 15px 25px;
					border-radius: 25px;
					box-shadow: 0 4px 12px var(--shadow-color);
					z-index: 1000;
					font-size: 14px;
					animation: slideDown 0.3s ease;
				`;
				message.innerHTML = '📡 Нет подключения к интернету. Показываются кэшированные данные.';
				document.body.appendChild(message);
				
				// Убираем сообщение через 5 секунд
				setTimeout(() => {
					if (message.parentNode) {
						message.style.animation = 'slideUp 0.3s ease';
						setTimeout(() => message.remove(), 300);
					}
				}, 5000);
			}
			
			function hideOfflineMessage() {
				const message = document.getElementById('offlineMessage');
				if (message) {
					message.style.animation = 'slideUp 0.3s ease';
					setTimeout(() => message.remove(), 300);
				}
			}
			
			// Регистрация Service Worker для PWA
			if ('serviceWorker' in navigator) {
				window.addEventListener('load', () => {
					navigator.serviceWorker.register(`${import.meta.env.BASE_URL}sw.js`)
						.then((registration) => {
							serviceWorkerRegistration = registration;
							
							// Проверяем обновления
							registration.addEventListener('updatefound', () => {
								const newWorker = registration.installing;
								newWorker.addEventListener('statechange', () => {
									if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
										// Новый SW готов, предлагаем обновление
										if (confirm('Доступно обновление приложения. Обновить сейчас?')) {
											newWorker.postMessage({ type: 'SKIP_WAITING' });
											window.location.reload();
										}
									}
								});
							});
						})
						.catch((registrationError) => {
							// Ошибка регистрации Service Worker
						});
				});
			}
			
			// Обработка установки PWA
			let deferredPrompt;
			window.addEventListener('beforeinstallprompt', (e) => {
				// Предотвращаем автоматическое появление баннера установки
				e.preventDefault();
				// Сохраняем событие для последующего использования
				deferredPrompt = e;
			});
			
			// Обработка успешной установки
			window.addEventListener('appinstalled', (evt) => {
				// PWA установлено
			});
			
			// Обработка изменений статуса соединения
			window.addEventListener('online', () => {
				updateOnlineStatus();
				hideOfflineMessage();
			});
			
			window.addEventListener('offline', () => {
				updateOnlineStatus();
				showOfflineMessage();
			});
			
			// Функция для обработки ошибок сети
			function handleNetworkError(error, context) {
				if (!isOnline) {
					showOfflineMessage();
				} else {
					// Показываем уведомление об ошибке сети
					const message = document.createElement('div');
					message.style.cssText = `
						position: fixed;
						top: 20px;
						left: 50%;
						transform: translateX(-50%);
						background: color-mix(in srgb, var(--gradient-end) 80%, black);
						color: white;
						padding: 15px 25px;
						border-radius: 25px;
						box-shadow: 0 4px 12px var(--shadow-color);
						z-index: 1000;
						font-size: 14px;
						animation: slideDown 0.3s ease;
					`;
					message.innerHTML = '⚠️ Ошибка загрузки данных. Проверьте соединение.';
					document.body.appendChild(message);
					
					setTimeout(() => {
						if (message.parentNode) {
							message.style.animation = 'slideUp 0.3s ease';
							setTimeout(() => message.remove(), 300);
						}
					}, 4000);
				}
			}
			
			// Функция для безопасной загрузки данных
			async function safeFetch(url, options = {}) {
				try {
					const response = await fetch(url, options);
					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					}
					return response;
				} catch (error) {
					handleNetworkError(error, 'safeFetch');
					throw error;
				}
			}
			
			// Перехватываем все fetch запросы для обработки ошибок
			const originalFetch = window.fetch;
			window.fetch = async function(...args) {
				try {
					return await originalFetch.apply(this, args);
				} catch (error) {
					handleNetworkError(error, 'fetch');
					throw error;
				}
			};
			
			// Инициализация статуса соединения
			updateOnlineStatus();
		</script>
	</body>
</html>
